
/**
 * @file Firestore Security Rules for CollectPro
 *
 * @corePhilosophy
 * This ruleset enforces a strict user-ownership model for user profiles and notification preferences,
 * ensuring that only authenticated users can access their own data. System-wide configurations are
 * restricted to users with admin privileges. The design prioritizes authorization independence
 * and eliminates the need for costly `get()` calls within security rules.
 *
 * @dataStructure
 * - `/users/{userId}`: Stores user profile data, including a denormalized 'role' field.
 * - `/users/{userId}/notification_preferences`: Stores notification preferences for each user.
 * - `/system_configurations/{configId}`: Stores system-wide configurations, accessible only to admins.
 * - `/roles_admin/{userId}`: Indicates admin role by document existence.
 * - `/call_dispositions/{dispositionId}`: Stores call outcomes logged by agents.
 * - `/teams/{teamId}`: Stores team data, managed by Admins.
 *
 * @keySecurityDecisions
 * - User data is nested under `/users/{userId}` to enforce ownership.
 * - Admin privileges are determined by the existence of a document in `/roles_admin/{userId}`.
 * - Team data is managed by Admins. Supervisors can read their team's data.
 * - Call dispositions can only be created by the authenticated agent assigned to the call.
 * - System configurations are secured and only accessible to admins.
 *
 * @denormalizationForAuthorization
 * The 'role' field is denormalized into the `/users/{userId}` document to avoid needing separate reads
 * to determine user roles. Admin privileges are determined by the existence of a document in
 * `/roles_admin/{userId}`, allowing simple existence checks in the rules.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    /**
     * @description Controls access to user profile data.
     * @path /users/{userId}
     */
    match /users/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow create: if isOwner(userId) && request.resource.data.id == request.auth.uid;
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Controls access to user notification preferences.
     * @path /users/{userId}/notification_preferences/{prefId}
     */
    match /users/{userId}/notification_preferences/{prefId} {
      allow read, write: if isOwner(userId);
    }

    /**
     * @description Controls access to system-wide configurations.
     * @path /system_configurations/{configId}
     */
    match /system_configurations/{configId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    /**
     * @description Grants admin access based on document existence.
     * @path /roles_admin/{userId}
     */
    match /roles_admin/{userId} {
      allow read, write: if isAdmin();
    }
    
    /**
     * @description Controls access to call disposition logs.
     * @path /call_dispositions/{dispositionId}
     */
    match /call_dispositions/{dispositionId} {
      allow create: if isSignedIn() && request.resource.data.agent_id == request.auth.uid;
      allow read: if isSignedIn() && (resource.data.agent_id == request.auth.uid || isAdmin()); // Supervisors should get access via a function
      allow list: if isSignedIn(); // For supervisors/admins, should be refined with role checks
      allow update, delete: if false; // Dispositions are immutable
    }

    /**
     * @description Controls access to teams.
     * @path /teams/{teamId}
     */
    match /teams/{teamId} {
        // Admins can create, read, update, delete teams.
        // Supervisors can read teams they are a leader of.
        allow read: if isAdmin() || (isSignedIn() && resource.data.leader_id == request.auth.uid);
        allow list: if isSignedIn();
        allow create, update, delete: if isAdmin();
    }
  }
}
